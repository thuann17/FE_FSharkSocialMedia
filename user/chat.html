<!DOCTYPE html>
<html lang="en" ng-app="chatApp">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Application</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" href="/user/css/main.min.css" />
  </head>
  <body ng-controller="ChatController">
    <div id="username-page" ng-hide="connected">
      <form id="usernameForm" ng-submit="connect()">
        <input
          type="text"
          id="name"
          ng-model="name"
          placeholder="Enter your name"
          required
        />
        <button type="submit">Start Chat</button>
      </form>
    </div>

    <div id="chat-page" ng-show="connected">
      <ul id="messageArea">
        <li ng-repeat="message in messages">
          <i ng-style="{'background-color': getAvatarColor(message.sender)}"
            >{{message.sender[0]}}</i
          >
          <span>{{message.sender}}</span>
          <p>{{message.content}}</p>
        </li>
      </ul>

      <form id="messageForm" ng-submit="sendMessage()">
        <input
          type="text"
          id="message"
          ng-model="messageContent"
          placeholder="Type a message..."
          required
        />
        <button type="submit">Send</button>
      </form>
      <div class="connecting" ng-show="connectingMessage">
        {{connectingMessage}}
      </div>
    </div>
  </body>
  <script>
    "use strict";

    var app = angular.module("chatApp", []);

    app.controller("ChatController", [
      "$scope",
      function ($scope) {
        $scope.name = "";
        $scope.messages = [];
        $scope.connected = false;
        $scope.connectingMessage = "";

        var stompClient = null;
        var colors = [
          "#2196F3",
          "#32c787",
          "#00BCD4",
          "#ff5652",
          "#ffc107",
          "#ff85af",
          "#FF9800",
          "#39bbb0",
        ];

        // Function to establish WebSocket connection
        $scope.connect = function () {
          if ($scope.name.trim()) {
            $scope.connected = true;
            $scope.connectingMessage = "Connecting...";

            // Initialize SockJS and Stomp
            var socket = new SockJS("http://localhost:8080/ws");
            stompClient = Stomp.over(socket);

            stompClient.connect(
              {},
              function (frame) {
                // On successful connection
                onConnected();
              },
              function (error) {
                // On error
                $scope.connectingMessage =
                  "Could not connect to WebSocket server. Please refresh this page to try again!";
                $scope.$apply();
              }
            );
          }
        };

        // Function to handle successful connection
        function onConnected() {
          // Subscribe to the public topic
          stompClient.subscribe("/topic/public", function (payload) {
            onMessageReceived(JSON.parse(payload.body));
          });

          // Send JOIN message to server
          stompClient.send(
            "/app/chat.addUser",
            {},
            JSON.stringify({
              sender: $scope.name,
              type: "JOIN",
            })
          );

          $scope.connectingMessage = "";
          $scope.$apply();
        }

        // Function to send chat messages
        $scope.sendMessage = function () {
          if ($scope.messageContent.trim() && stompClient) {
            var chatMessage = {
              sender: $scope.name,
              content: $scope.messageContent,
              type: "CHAT",
            };

            stompClient.send(
              "/app/chat.sendMessage",
              {},
              JSON.stringify(chatMessage)
            );
            $scope.messageContent = ""; // Clear the input field after sending
          }
        };

        // Function to handle received messages
        function onMessageReceived(message) {
          if (message.type === "JOIN") {
            message.content = message.sender + " joined!";
          } else if (message.type === "LEAVE") {
            message.content = message.sender + " left!";
          }

          $scope.messages.push(message);
          $scope.$apply();
        }

        // Function to assign colors to avatars
        $scope.getAvatarColor = function (messageSender) {
          var hash = 0;
          for (var i = 0; i < messageSender.length; i++) {
            hash = 31 * hash + messageSender.charCodeAt(i);
          }
          var index = Math.abs(hash % colors.length);
          return colors[index];
        };
      },
    ]);
  </script>
</html>
