<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Application</title>
  </head>
  <body>
    <div ng-app="chatApp" ng-controller="ChatController">
      <div>
        <h3>Your Friends</h3>
        <ul>
          <li ng-repeat="friend in friends" ng-click="loadMessages(friend)">
            {{ friend.username }}
          </li>
        </ul>
      </div>
      <div ng-if="selectedFriend">
        <h3>Chat with {{ selectedFriend.username }}</h3>
        <div>
          <div ng-repeat="msg in messages">
            <strong>{{ msg.sender }}:</strong> {{ msg.content }}
          </div>
        </div>
        <input
          type="text"
          ng-model="newMessage"
          placeholder="Type a message..."
          ng-keyup="$event.keyCode === 13 && sendMessage()"
        />
        <button ng-click="sendMessage()">Send</button>
      </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-cookies.min.js"></script>
    <script src="https://cdn.jsdelivr.net/sockjs/1.1.4/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
      // Define the AngularJS app
      var app = angular.module("chatApp", ["ngCookies"]);

      // WebSocket Service
      app.service("WebSocketService", function ($q, $timeout) {
        var service = {};
        var listener = $q.defer();
        var socket = {
          client: null,
          stomp: null,
        };

        service.RECONNECT_TIMEOUT = 30000;
        service.SOCKET_URL = "/ws";
        service.CHAT_TOPIC = "/queue/";
        service.CHAT_BROKER = "/app/chat";

        service.receive = function () {
          return listener.promise;
        };

        service.send = function (destination, message) {
          socket.stomp.send(
            service.CHAT_BROKER + destination,
            {},
            JSON.stringify(message)
          );
        };

        var reconnect = function () {
          $timeout(function () {
            initialize();
          }, service.RECONNECT_TIMEOUT);
        };

        var getMessage = function (data) {
          return JSON.parse(data);
        };

        var startListener = function () {
          socket.stomp.subscribe(
            service.CHAT_TOPIC + socket.username,
            function (data) {
              listener.notify(getMessage(data.body));
            }
          );
        };

        var initialize = function () {
          socket.client = new SockJS(service.SOCKET_URL);
          socket.stomp = Stomp.over(socket.client);
          socket.stomp.connect({}, startListener, reconnect);
        };

        service.init = function (username) {
          socket.username = username;
          initialize();
        };

        return service;
      });

      // Chat Service for handling HTTP requests to the backend
      app.service("ChatService", function ($http) {
        this.getMessagesBetweenUsers = function (user1, user2) {
          return $http.get("/api/chat/messages", {
            params: { user1: user1, user2: user2 },
          });
        };

        this.getFriends = function (username) {
          return $http.get("/api/chat/list/" + username);
        };
      });

      // Chat Controller
      app.controller(
        "ChatController",
        function ($scope, $cookies, WebSocketService, ChatService) {
          // Retrieve the username from cookies
          $scope.username = $cookies.get("username");
          $scope.selectedFriend = null;
          $scope.messages = [];
          $scope.newMessage = "";
          $scope.friends = [];

          // Load friends list
          ChatService.getFriends($scope.username).then(function (response) {
            $scope.friends = response.data;
          });

          // Load messages with a selected friend
          $scope.loadMessages = function (friend) {
            $scope.selectedFriend = friend;
            ChatService.getMessagesBetweenUsers(
              $scope.username,
              friend.username
            ).then(function (response) {
              $scope.messages = response.data;
            });
          };

          // Send a new message
          $scope.sendMessage = function () {
            if ($scope.newMessage.trim() !== "") {
              var message = {
                sender: $scope.username,
                reciver: $scope.selectedFriend.username,
                content: $scope.newMessage,
              };
              WebSocketService.send(
                "/chat/" + $scope.selectedFriend.username,
                message
              );
              $scope.messages.push(message);
              $scope.newMessage = ""; // Clear input
            }
          };

          // Listen for incoming messages
          WebSocketService.receive().then(null, null, function (message) {
            $scope.$apply(function () {
              if (message.sender === $scope.selectedFriend.username) {
                $scope.messages.push(message);
              }
            });
          });

          // Initialize WebSocket connection with the username
          WebSocketService.init($scope.username);
        }
      );
    </script>
  </body>
</html>
